# `gaussian.py` 모듈 상세 분석 보고서

이 문서는 `backend/core/gaussian.py` 모듈의 역할, 주요 로직, 그리고 각 함수/메서드의 입출력 및 그 목적에 대해 상세히 분석합니다.

## 모듈의 핵심 역할

`gaussian.py` 모듈은 이 프로젝트의 가장 근본적인 데이터 단위인 **`Gaussian2D` 객체**를 정의하고 관리합니다. 3D Gaussian Splatting 기법을 2D 페인팅에 맞게 단순화하여, 2D 평면상의 타원(Ellipse) 형태를 가진 '점' 하나하나를 표현합니다. 모든 렌더링은 이 `Gaussian2D` 객체들을 화면에 그려내는 과정입니다.

---

## `Gaussian2D` 클래스 분석

### 1. 클래스 역할

2D 가우시안 스플랫 하나를 표현하는 데이터 클래스입니다. 3D 공간상의 오브젝트이지만, 이 프로젝트에서는 z=0 평면에 고정하여 2D처럼 보이게 만듭니다. 각 `Gaussian2D` 객체는 위치, 크기(비율), 회전, 불투명도, 색상 정보를 가집니다.

### 2. 주요 속성 (Attributes)

*   `position`: `np.ndarray` - 가우시안의 3D 위치 (x, y, z). `__init__`에서 z값은 0으로 강제됩니다.
*   `scale`: `np.ndarray` - 가우시안의 3축 크기 (sx, sy, sz). `__init__`에서 z축 크기는 매우 작게 설정하여 2D처럼 보이게 합니다.
*   `rotation`: `np.ndarray` - 쿼터니언(Quaternion)으로 표현되는 3D 회전값 (x, y, z, w). 2D 평면에서의 회전을 표현합니다.
*   `opacity`: `float` - 불투명도 (0.0 ~ 1.0).
*   `color`: `np.ndarray` - RGB 색상값.

### 3. 주요 메서드 (Methods) 분석

#### `__init__(self, ...)`
*   **역할**: `Gaussian2D` 객체를 생성하고 초기화합니다.
*   **입력**: `position`, `scale`, `rotation`, `opacity`, `color` 등 가우시안을 정의하는 모든 속성값.
*   **로직 분석**:
    *   **로직**: 입력받은 `position`의 z값을 0으로, `scale`의 z값을 아주 작은 값(1e-4)으로 강제합니다.
    *   **이유**: 3D 가우시안을 2D 평면에 한정시켜 2D 페인팅처럼 보이게 만들기 위함입니다.
    *   **로직**: 입력받은 회전값(쿼터니언)을 `_normalize_quaternion` 메서드를 통해 정규화합니다.
    *   **이유**: 수학적으로 안정적인 회전 계산을 위해 크기가 1인 단위 쿼터니언을 유지해야 하기 때문입니다.

#### `compute_covariance_2d(self, ...)`
*   **역할**: 렌더링에 사용될 2D 공분산 행렬(Covariance Matrix)을 계산합니다. 이 행렬은 가우시안의 2D 타원 모양(크기, 방향)을 수학적으로 정의합니다.
*   **출력**: 2x2 크기의 `np.ndarray` (공분산 행렬).
*   **로직 분석**:
    1.  **로직**: 먼저 쿼터니언(`self.rotation`)과 스케일(`self.scale`)로부터 3D 공분산 행렬 `Σ = R S S^T R^T`를 계산합니다. (`R`은 회전 행렬, `S`는 크기 행렬)
    2.  **이유**: 이 공식은 3D 공간에서 특정 크기와 회전을 가진 타원체를 표현하는 표준적인 선형대수 공식입니다.
    3.  **로직**: 위에서 계산된 3D 공분산 행렬(3x3)에서 z축 성분을 제외하고, x, y에 해당하는 상위 2x2 부분만 잘라내어 반환합니다.
    4.  **이유**: 2D 평면에 투영(Orthographic Projection)된 타원의 모양은 3D 공분산 행렬의 2D 부분과 동일하기 때문에, 복잡한 투영 계산을 단순화한 것입니다.

#### `get_ellipse_parameters(self)`
*   **역할**: 디버깅이나 시각화를 위해, 공분산 행렬로부터 사람이 이해하기 쉬운 타원의 파라미터(장축, 단축, 회전각)를 추출합니다.
*   **출력**: `(장축 길이, 단축 길이, 회전각)`을 담은 튜플.
*   **로직 분석**:
    1.  **로직**: `compute_covariance_2d()`로 얻은 2x2 공분산 행렬의 **고유값(eigenvalues)과 고유벡터(eigenvectors)**를 계산합니다.
    2.  **이유**: 공분산 행렬의 고유값은 타원의 각 축 방향으로의 분산(퍼짐 정도)을, 고유벡터는 그 축의 방향을 나타냅니다. 이는 타원의 기하학적 속성을 추출하는 표준적인 방법입니다.
    3.  **로직**: 계산된 고유값으로부터 타원의 장축과 단축 길이를, 고유벡터로부터 회전 각도를 계산하여 반환합니다.

#### `transform(self, transform_matrix)`
*   **역할**: 4x4 동차 변환 행렬(Homogeneous Transformation Matrix)을 현재 가우시안에 적용하여, 변환된 **새로운** `Gaussian2D` 객체를 반환합니다. (예: 브러시 전체를 이동/회전시킬 때 사용)
*   **입력**: 4x4 `np.ndarray` (변환 행렬).
*   **출력**: 변환이 적용된 새로운 `Gaussian2D` 객체.
*   **로직 분석**:
    1.  **로직**: 입력된 4x4 행렬을 사용하여 가우시안의 `position`(위치)을 변환합니다.
    2.  **로직**: 행렬의 3x3 회전 부분을 추출하여 기존의 `rotation`(쿼터니언)과 결합한 후, 새로운 회전값(쿼터니언)을 계산합니다.
    3.  **이유**: 쿼터니언으로 표현된 회전을 행렬 기반의 변환과 일관되게 적용하기 위함입니다. 쿼터니언을 행렬로 변환 -> 두 회전 행렬을 곱함 -> 결과를 다시 쿼터니언으로 변환하는 표준적인 절차를 따릅니다.
